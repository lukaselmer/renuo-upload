var RenuoUpload,bind=function(e,n){return function(){return e.apply(n,arguments)}};RenuoUpload=function(){function e(e,n,t,o){this.apikey=e,this.element=n,this.dropzoneOptions=t,this.callback=o,this._initializeDropzone=bind(this._initializeDropzone,this),this._checkRequirements(),this._checkAdaptParams(),$.when(this._getCredentials()).done(this._initializeDropzone)}return e.prototype._initializeDropzone=function(){var e;return Dropzone.autoDiscover=!1,$(this.element).addClass("dropzone"),e=new Dropzone(this.element,this.dropzoneOptions),e.on("success",function(e){return function(n){return e.callback(e._buildResult(n))}}(this)),e.on("error",function(){})},e.prototype._cleanFilename=function(e){return e.toLowerCase().replace(/[ _]/g,"-").replace(/[^\w-.]/g,"")},e.prototype._getExtension=function(e){return e.split(".").pop()},e.prototype._getShortName=function(e){return e.replace(/\.[^\/.]+$/,"")},e.prototype._getPublicUrl=function(e){return""+this.cdnPath+e},e.prototype._getCredentials=function(){return $.ajax({type:"POST",url:"domain/generate_policy",data:{api_key:this.apikey},dataType:"json"}).done(function(e){return function(n){return e.dropzoneOptions.url=n.url,e.dropzoneOptions.params={},$.each(n.data,function(n,t){return e.dropzoneOptions.params[n.replace(/_/g,"-")]=t}),e.cdnPath=""}}(this)).fail(function(){throw new Error("Failed to get credential for upload.")})},e.prototype._buildResult=function(e){var n;return n=this._cleanFilename(e.name),{orginalName:e.name,cleanName:n,name:this._getShortName(n),extension:this._getExtension(e.name),size:e.size,publicUrl:this._getPublicUrl(n)}},e.prototype._checkAdaptParams=function(){return this._checkElement(),this._adaptCallback(),this._adaptOptions()},e.prototype._checkRequirements=function(){if("undefined"==typeof jQuery||null===jQuery)throw new Error("RenuoUpload needs jQuery.");if("undefined"==typeof Dropzone||null===Dropzone)throw new Error("RenuoUpload needs Dropzone.")},e.prototype._checkElement=function(){if(null==this.element)throw new Error("Element is not defined");if(null!=this.element[0].nodeType&&(this.element=this.element[0]),null==this.element.nodeType)throw new Error("Element is not a valid element")},e.prototype._adaptOptions=function(){if(null==this.dropzoneOptions)throw new Error("DropzoneOptions is not defined");if(null==this.dropzoneOptions.acceptedFiles)throw new Error("DropzoneOptions.acceptedFiles is not defined");if("string"!=typeof this.dropzoneOptions.acceptedFiles)throw new Error("DropzoneOptions.acceptedFiles is not a string");return null==this.dropzoneOptions.parallelUploads&&(this.dropzoneOptions.parallelUploads=25),null==this.dropzoneOptions.renameFilename?this.dropzoneOptions.renameFilename=this._cleanFilename:void 0},e.prototype._adaptCallback=function(){return"function"!=typeof this.callback?this.callback=this._defaultCallback:void 0},e.prototype._defaultCallback=function(e){var n;return $(this.element).parents("form").length?(n=e.name,delete e.name,$.each(e,function(e){return function(t,o){return $(e.element).parents("form").append("<input type='hidden' name='renuoupload["+n+"]["+t+"]' value='"+o+"'>")}}(this))):void 0},e}(),"undefined"!=typeof module&&null!==module?module.exports=RenuoUpload:window.RenuoUpload=RenuoUpload;